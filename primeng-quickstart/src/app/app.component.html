<p-toast position="bottom-center"></p-toast>

<!-- Non-cancelable ConfirmDialog shown when SignalR is lost or start fails -->
<p-confirmdialog
  [key]="'conn-lost'"
  [rejectVisible]="false"
  [closable]="false"
  [closeOnEscape]="false"
  [dismissableMask]="false"
></p-confirmdialog>

<!-- Generic confirm dialog (for actions like Delete) -->
<p-confirmdialog></p-confirmdialog>

<!-- Boot gating:
     - Show ONLY the loader while the hub is connecting
     - After connected, still show loader until initial lists finish loading
     - If hub failed: show nothing here (only the dialog is visible) -->
@if (hubStatus() === 'connecting' || (hubStatus() === 'connected' && listsLoading())) {
  <div style="height: 100vh; width: 100%; display: grid; place-items: center">
    <app-loading-indicator></app-loading-indicator>
  </div>
} @else if (hubStatus() === 'connected') {

  <!-- Full-page flex column: toolbar on top, splitter fills the rest -->
  <div style="height: 100vh; width: 100%; display: flex; flex-direction: column">
    <!-- Global toolbar -->
    <p-toolbar>
      <ng-template pTemplate="start">
        <div style="display: flex; align-items: center; gap: 0.5rem">
          <p-select
            inputId="dataSource"
            [options]="dataSources"
            [formControl]="engineControl"
            optionLabel="label"
            optionValue="value"
            styleClass="w-16rem"
            placeholder="Datenquelle auswählen"
          >
          </p-select>
        </div>
      </ng-template>

      <ng-template pTemplate="end">
        <button
          pButton
          type="button"
          icon="pi pi-download"
          label="Download"
          class="p-button-outlined"
          style="margin-left: 0.5rem"
          (click)="onDownload()"
        ></button>
      </ng-template>
    </p-toolbar>

    <div class="splitter-wrapper">
      <p-splitter
        [style]="{ height: '100%', width: '100%' }"
        [panelSizes]="[25, 75]"
        [minSizes]="[15, 10]"
        layout="horizontal"
      >
        <!-- Left panel -->
        <ng-template #panel>
          <div style="display: flex; flex-direction: column; width: 100%; height: 100%">
            <!-- Clearable search -->
            <div style="margin-bottom: 0.5rem; padding: 10px 10px 0 10px">
              <div class="search-clearable" style="position: relative; width: 100%">
                <p-iconfield iconPosition="left" class="w-full">
                  <p-inputicon styleClass="pi pi-search"></p-inputicon>

                  <input
                    #filterInput
                    id="list-filter-input"
                    pInputText
                    [(ngModel)]="listFilter"
                    (ngModelChange)="applyFilter($event)"
                    type="text"
                    placeholder="Suchen…"
                    class="w-full"
                    style="padding-right: 2.25rem"
                  />
                </p-iconfield>

                @if (listFilter?.length) {
                  <button
                    type="button"
                    pButton
                    class="p-button-text p-button-plain p-button-rounded p-button-icon-only"
                    (click)="clearSearch()"
                    aria-label="Suche löschen"
                    style="
                      position: absolute;
                      right: .35rem;
                      top: 50%;
                      transform: translateY(-50%);
                      width: 1.75rem;
                      height: 1.75rem;"
                  >
                    <span class="p-button-icon pi pi-times"></span>
                  </button>
                }
              </div>
            </div>

            <!-- Grouped Listbox -->
            <p-listbox
              [group]="true"
              [options]="groupedOptions"
              optionGroupLabel="label"
              optionGroupChildren="items"
              [formControl]="listControl"
              optionLabel="label"
              optionValue="value"
              [optionDisabled]="isOptionDisabled"
              [style]="{ width: '100%', 'flex-grow': '1', overflow: 'auto', border: 'none', boxShadow: 'none' }"
              [listStyle]="{ overflow: 'auto', 'max-height': '100%' }"
              styleClass="left-listbox"
            >
              <ng-template pTemplate="group" let-group>
                <div
                  style="font-weight: 700; color: var(--p-primary-color); text-transform: uppercase; letter-spacing: 0.02em"
                >
                  {{ group.label }}
                </div>
              </ng-template>

              <ng-template pTemplate="item" let-item>
                <div
                  [style.padding-left]="item.__placeholder ? '.25rem' : '1rem'"
                  [style.fontStyle]="item.__placeholder ? 'italic' : null"
                  [style.opacity]="item.__placeholder ? 0.75 : 1"
                >
                  {{ item.label }}
                </div>
              </ng-template>
            </p-listbox>
          </div>
        </ng-template>

        <!-- Right panel -->
        <ng-template #panel>
          <div class="right-panel" style="display: flex; flex-direction: column; height: 100%">
            @if (renderTable()) {

              <!-- Nothing selected → neutral message (outside of table) -->
              @if (!selectedListItem()) {
                <div style="height: 100%; display: grid; place-items: center; text-align: center; padding: 1rem">
                  <div>
                    <i class="pi pi-table" style="font-size: 1.35rem; opacity: .7"></i>
                    <div style="margin-top: .5rem; opacity: .8">
                      @if (isExcel()) {
                        Keine <strong>Tabelle</strong> ausgewählt.
                      } @else {
                        Keine <strong>Tabelle</strong> oder <strong>Sicht</strong> ausgewählt.
                      }
                    </div>
                  </div>
                </div>
              } @else {

                <!-- Context toolbar (only when a table/view is selected) -->
                <p-toolbar styleClass="right-panel-toolbar">
                  <ng-template pTemplate="start">
                    <div style="display:flex; align-items:center; gap:.5rem">
                      <i class="pi pi-table" style="opacity:.7"></i>
                      <span style="font-weight:600">{{ selectedListItem()?.label }}</span>
                      <span style="opacity:.7">· {{ totalCount() }} Zeilen</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="end">
                    <button
                      pButton
                      type="button"
                      icon="pi pi-trash"
                      label="Löschen"
                      class="p-button-danger p-button-outlined"
                      [disabled]="!selectedListItem()"
                      (click)="onDeleteSelected()"
                    ></button>
                  </ng-template>
                </p-toolbar>

                <!-- Render only after BOTH data + fresh columns are ready -->
                @if (loadingSelection() || loadingRows()) {
                  <app-loading-indicator></app-loading-indicator>
                } @else {

                  <!-- Data finished loading → always render the table.
                       Headers come from columnNames(); emptymessage handles 0 rows. -->
                  <p-table
                    style="overflow: hidden"
                    [value]="rows()"
                    size="small"
                    dataKey="id"
                    [rowTrackBy]="rowTrackBy"
                    showGridlines
                    [resizableColumns]="true"
                    columnResizeMode="expand"
                    (onColResize)="onColResize()"

                    [paginator]="true"
                    paginatorPosition="bottom"
                    [rows]="pageSize()"
                    [totalRecords]="totalCount()"
                    [first]="pageIndex() * pageSize()"
                    [showCurrentPageReport]="true"
                    currentPageReportTemplate="{first} bis {last} von {totalRecords}"

                    [scrollable]="true"
                    scrollHeight="flex"
                    [style]="{ flex: '1 1 0' }"
                    [tableStyle]="{ width: 'max-content' }"

                    sortMode="single"
                    [sortField]="sortBy() ?? ''"
                    [sortOrder]="sortDir() === 'asc' ? 1 : -1"
                    (onSort)="onSort($event)"

                    (onPage)="onPage($event)"

                    [lazy]="true"
                    [lazyLoadOnInit]="false"
                  >
                    <ng-template pTemplate="colgroup">
                      <colgroup>
                        @for (col of columnNames(); track col) {
                          <col [style.width]="getColWidth(col) || null"/>
                        }
                      </colgroup>
                    </ng-template>

                    <ng-template pTemplate="header">
                      <tr>
                        @for (col of columnNames(); track col) {
                          <th pResizableColumn [pSortableColumn]="col">
                            <div style="display: flex; align-items: center; gap: 0.5rem">
                              {{ col }}
                              <p-sortIcon [field]="col"></p-sortIcon>
                            </div>
                          </th>
                        }
                      </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-row>
                      <tr>
                        @for (col of columnNames(); track col) {
                          <td
                            [style.text-align]="isNumber(row[col]) ? 'right' : 'left'"
                            style="font-variant-numeric: tabular-nums"
                          >
                            {{ row[col] }}
                          </td>
                        }
                      </tr>
                    </ng-template>

                    <!-- No rows → keep headers visible and show message inside the table -->
                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td [attr.colspan]="columnNames().length || 1">
                          <div style="padding: 0.75rem">
                            Keine Daten vorhanden.
                          </div>
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                }
              }
            }
          </div>
        </ng-template>

      </p-splitter>
    </div>
  </div>
}
