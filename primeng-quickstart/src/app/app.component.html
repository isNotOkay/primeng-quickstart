<!-- file: src/app/app.component.html -->
<p-toast position="bottom-center"></p-toast>

<!-- Full-page flex column: toolbar on top, splitter fills the rest -->
<div style="height: 100vh; width: 100%; display: flex; flex-direction: column">
  <!-- Global toolbar -->
  <p-toolbar>
    <ng-template pTemplate="start">
      <div style="display: flex; align-items: center; gap: 0.5rem">
        <p-select
          inputId="dataSource"
          [options]="dataSources"
          [formControl]="engineControl"
          optionLabel="label"
          optionValue="value"
          styleClass="w-16rem"
          placeholder="Datenquelle auswählen"
        >
        </p-select>
      </div>
    </ng-template>

    <ng-template pTemplate="end">
      <button
        pButton
        type="button"
        icon="pi pi-download"
        label="Download"
        class="p-button-outlined"
        style="margin-left: 0.5rem"
        (click)="onDownload()"
      ></button>
    </ng-template>
  </p-toolbar>

  <div class="splitter-wrapper">
    @if (listsLoading()) {
      <app-loading-indicator></app-loading-indicator>
    }

    <p-splitter
      [style]="{ height: '100%', width: '100%' }"
      [panelSizes]="[25, 75]"
      [minSizes]="[15, 10]"
      layout="horizontal"
    >
      <!-- Left panel -->
      <ng-template #panel>
        <div style="display: flex; flex-direction: column; width: 100%; height: 100%">
          <!-- External filter -->
          <div style="margin-bottom: 0.5rem; padding: 10px 10px 0 10px">
            <p-iconfield iconPosition="left">
              <p-inputicon styleClass="pi pi-search"></p-inputicon>

              <input
                #filterInput
                pInputText
                [(ngModel)]="listFilter"
                (ngModelChange)="applyFilter($event)"
                type="text"
                placeholder="Suchen…"
                class="w-full"
              />
            </p-iconfield>
          </div>

          <!-- Grouped Listbox -->
          <p-listbox
            [group]="true"
            [options]="groupedOptions"
            optionGroupLabel="label"
            optionGroupChildren="items"
            [formControl]="listControl"
            optionLabel="label"
            optionValue="value"
            [optionDisabled]="isOptionDisabled"
            [style]="{ width: '100%', 'flex-grow': '1', overflow: 'auto', border: 'none', boxShadow: 'none' }"
            [listStyle]="{ overflow: 'auto', 'max-height': '100%' }"
            styleClass="left-listbox"
          >
            <ng-template pTemplate="group" let-group>
              <div
                style="font-weight: 700; color: var(--p-primary-color); text-transform: uppercase; letter-spacing: 0.02em"
              >
                {{ group.label }}
              </div>
            </ng-template>

            <ng-template pTemplate="item" let-item>
              <div
                [style.padding-left]="item.__placeholder ? '.25rem' : '1rem'"
                [style.fontStyle]="item.__placeholder ? 'italic' : null"
                [style.opacity]="item.__placeholder ? 0.75 : 1"
              >
                {{ item.label }}
              </div>
            </ng-template>
          </p-listbox>
        </div>
      </ng-template>

      <!-- Right panel -->
      <ng-template #panel>
        <div class="right-panel">
          @if (renderTable()) {

            <!-- Custom loader (not PrimeNG overlay) -->
            @if (loadingRows()) {
              <app-loading-indicator></app-loading-indicator>
            }

            <p-table
              [value]="rows()"
              size="small"
              dataKey="id"
              [rowTrackBy]="rowTrackBy"
              showGridlines
              [resizableColumns]="true"
              columnResizeMode="expand"
              (onColResize)="onColResize()"

              [paginator]="true"
              paginatorPosition="bottom"
              [rows]="pageSize()"
              [totalRecords]="totalCount()"
              [first]="pageIndex() * pageSize()"
              [showCurrentPageReport]="true"
              currentPageReportTemplate="{first} bis {last} von {totalRecords}"

              [scrollable]="true"
              scrollHeight="flex"
              [style]="{ flex: '1 1 0' }"
              [tableStyle]="{ width: 'max-content' }"

              sortMode="single"
              [sortField]="sortBy() ?? ''"
              [sortOrder]="sortDir() === 'asc' ? 1 : -1"
              (onSort)="onSort($event)"

              (onPage)="onPage($event)"

              [lazy]="true"
              [lazyLoadOnInit]="false"
            >
              <!-- Apply cached widths to both header & body via <colgroup> -->
              <ng-template pTemplate="colgroup">
                <colgroup>
                  @for (col of columnNames(); track col) {
                    <col [style.width]="getColWidth(col) || null" />
                  }
                </colgroup>
              </ng-template>

              <ng-template pTemplate="header">
                <tr>
                  @for (col of columnNames(); track col) {
                    <th pResizableColumn [pSortableColumn]="col">
                      <div style="display: flex; align-items: center; gap: 0.5rem">
                        {{ col }}
                        <p-sortIcon [field]="col"></p-sortIcon>
                      </div>
                    </th>
                  }
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-row>
                <tr>
                  @for (col of columnNames(); track col) {
                    <td
                      [style.text-align]="isNumber(row[col]) ? 'right' : 'left'"
                      style="font-variant-numeric: tabular-nums"
                    >
                      {{ row[col] }}
                    </td>
                  }
                </tr>
              </ng-template>

              <ng-template pTemplate="emptymessage">
                <tr>
                  <td [attr.colspan]="columnNames().length || 1">
                    <div style="padding: 0.75rem">
                      Keine Daten vorhanden. Bitte wählen Sie links eine Tabelle oder Sicht.
                    </div>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          }
        </div>
      </ng-template>
    </p-splitter>
  </div>
</div>
