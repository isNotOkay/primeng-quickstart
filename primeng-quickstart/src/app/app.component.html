<p-toast position="bottom-center"></p-toast>

<p-confirmdialog
  [key]="'conn-lost'"
  [rejectVisible]="false"
  [closable]="false"
  [closeOnEscape]="false"
  [dismissableMask]="false"
></p-confirmdialog>

<p-confirmdialog></p-confirmdialog>

@if (
  hubStatus() === 'connecting' ||
  (hubStatus() === 'connected' && !loadedTablesAndViews() && tableItems().length === 0 && viewItems().length === 0)
) {
  <div class="loading-container">
    <app-loading-indicator></app-loading-indicator>
  </div>
} @else if (hubStatus() === 'connected') {
  <div class="main-container">
    <p-toolbar>
      <ng-template pTemplate="start">
        <div class="toolbar-start">
          <p-select
            size="small"
            inputId="dataSource"
            [options]="dataSources"
            [formControl]="engineControl"
            optionLabel="label"
            optionValue="value"
            styleClass="w-16rem"
            placeholder="Datenquelle auswählen"
          >
          </p-select>
        </div>
      </ng-template>

      <ng-template pTemplate="end">
        <p-button
          label="Download"
          icon="pi pi-download"
          severity="secondary"
          variant="outlined"
          size="small"
          (click)="onDownload()"
        />
      </ng-template>
    </p-toolbar>

    <div class="splitter-wrapper">
      <p-splitter
        [style]="{ height: '100%', width: '100%' }"
        [panelSizes]="[25, 75]"
        [minSizes]="[15, 10]"
        layout="horizontal"
      >
        <ng-template #panel>
          <div class="left-panel-container">
            <div class="search-container">
              <div class="search-clearable">
                <p-iconfield iconPosition="left" class="w-full">
                  <p-inputicon styleClass="pi pi-search"></p-inputicon>

                  <input
                    #filterInput
                    pSize="small"
                    id="list-filter-input"
                    pInputText
                    [(ngModel)]="listFilter"
                    (ngModelChange)="applyFilter($event)"
                    type="text"
                    placeholder="Suchen…"
                    class="w-full search-input"
                  />
                </p-iconfield>

                @if (listFilter?.length) {
                  <button
                    type="button"
                    pButton
                    class="p-button-text p-button-plain p-button-rounded p-button-icon-only clear-button"
                    (click)="clearSearch()"
                    aria-label="Suche löschen"
                  >
                    <span class="p-button-icon pi pi-times"></span>
                  </button>
                }
              </div>
            </div>

            <p-listbox
              [group]="true"
              [options]="groupedOptions"
              optionGroupLabel="label"
              optionGroupChildren="items"
              [formControl]="listControl"
              optionLabel="label"
              optionValue="value"
              [optionDisabled]="isOptionDisabled"
              [style]="{ width: '100%', 'flex-grow': '1', overflow: 'auto', border: 'none', boxShadow: 'none' }"
              [listStyle]="{ overflow: 'auto', 'max-height': '100%' }"
              styleClass="left-listbox"
            >
              <ng-template pTemplate="group" let-group>
                <div class="group-header">
                  {{ group.label }}
                </div>
              </ng-template>

              <ng-template pTemplate="item" let-item>
                <div
                  [style.padding-left]="item.__placeholder ? '.25rem' : '1rem'"
                  [style.fontStyle]="item.__placeholder ? 'italic' : null"
                  [style.opacity]="item.__placeholder ? 0.75 : 1"
                >
                  {{ item.label }}
                </div>
              </ng-template>
            </p-listbox>

            @if (listsLoading() && (tableItems().length > 0 || viewItems().length > 0)) {
              <app-loading-indicator></app-loading-indicator>
            }
          </div>
        </ng-template>

        <ng-template #panel>
          <div class="right-panel">
            @if (renderTable()) {
              @if (!selectedListItem()) {
                <div class="empty-state-container">
                  <div>
                    <i class="pi pi-table icon-large"></i>
                    <div class="empty-state-text">
                      @if (isExcel()) {
                        Keine <strong>Tabelle</strong> ausgewählt.
                      } @else {
                        Keine <strong>Tabelle</strong> oder <strong>Sicht</strong> ausgewählt.
                      }
                    </div>
                  </div>
                </div>
              } @else {
                <p-toolbar class="right-panel-toolbar">
                  <ng-template pTemplate="start">
                    <div class="toolbar-content">
                      <i class="pi pi-table icon-muted"></i>
                      <span class="text-bold">{{ selectedListItem()?.label }}</span>
                      <span class="text-muted">· {{ totalCount() }} Zeilen</span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="end">
                    <p-button
                      id="toolbar-delete"
                      label="Löschen"
                      icon="pi pi-trash"
                      severity="danger"
                      variant="outlined"
                      size="small"
                      [disabled]="!selectedListItem()"
                      (click)="onDeleteSelected()"
                    />
                  </ng-template>
                </p-toolbar>

                <p-table
                  class="table-overflow"
                  [value]="rows()"
                  size="small"
                  dataKey="id"
                  [rowTrackBy]="rowTrackBy"
                  showGridlines
                  [resizableColumns]="true"
                  columnResizeMode="expand"
                  (onColResize)="onColResize()"
                  [paginator]="true"
                  paginatorPosition="bottom"
                  [rows]="pageSize()"
                  [totalRecords]="totalCount()"
                  [first]="pageIndex() * pageSize()"
                  [showCurrentPageReport]="true"
                  currentPageReportTemplate="{first} bis {last} von {totalRecords}"
                  [scrollable]="true"
                  scrollHeight="flex"
                  [style]="{ flex: '1 1 0' }"
                  [tableStyle]="{ width: 'max-content' }"
                  sortMode="single"
                  [sortField]="sortBy() ?? ''"
                  [sortOrder]="sortDir() === 'asc' ? 1 : -1"
                  (onSort)="onSort($event)"
                  (onPage)="onPage($event)"
                  [lazy]="true"
                  [lazyLoadOnInit]="false"
                >
                  <ng-template pTemplate="colgroup">
                    <colgroup>
                      @for (col of columnNames(); track col) {
                        <col [style.width]="getColWidth(col) || defaultColWidth()" />
                      }
                    </colgroup>
                  </ng-template>

                  <ng-template pTemplate="header">
                    <tr>
                      @for (col of columnNames(); track col) {
                        <th pResizableColumn [pSortableColumn]="col">
                          <div class="header-cell-content">
                            {{ col }}
                            <p-sortIcon [field]="col"></p-sortIcon>
                          </div>
                        </th>
                      }
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="body" let-row>
                    <tr>
                      @for (col of columnNames(); track col) {
                        <td [style.text-align]="isNumber(row[col]) ? 'right' : 'left'" class="numeric-cell">
                          {{ row[col] }}
                        </td>
                      }
                    </tr>
                  </ng-template>

                  <ng-template pTemplate="emptymessage">
                    <tr>
                      <td [attr.colspan]="columnNames().length || 1">
                        <div class="empty-message">Keine Daten vorhanden.</div>
                      </td>
                    </tr>
                  </ng-template>
                </p-table>

                @if (loadingSelection() || loadingRows()) {
                  <app-loading-indicator></app-loading-indicator>
                }
              }
            }
          </div>
        </ng-template>
      </p-splitter>
    </div>
  </div>
}
