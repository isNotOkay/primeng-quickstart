<!-- file: src/app/app.component.html -->
<!-- Full-page flex column: toolbar on top, splitter fills the rest -->
<div style="height:100vh; width:100%; display:flex; flex-direction:column">

  <!-- Global toolbar -->
  <p-toolbar>
    <ng-template pTemplate="start">
      <div style="display:flex; align-items:center; gap:.5rem">
        <p-select
          inputId="dataSource"
          [options]="dataSources"
          [(ngModel)]="selectedDataSource"
          optionLabel="label"
          optionValue="value"
          styleClass="w-16rem"
          placeholder="Datenquelle auswählen">
        </p-select>
      </div>
    </ng-template>

    <ng-template pTemplate="end">
      <!-- NEW: Add Column button -->
      <button pButton type="button" icon="pi pi-plus" label="Add Column"
              class="p-button-outlined" (click)="addColumn()"></button>

      <button pButton type="button" icon="pi pi-download" label="Download" class="p-button-outlined"
              style="margin-left:.5rem"></button>
    </ng-template>
  </p-toolbar>

  <!-- Splitter takes remaining height -->
  <p-splitter
    [style]="{ 'flex-grow': 1, 'overflow': 'hidden', width: '100%' }"
    [panelSizes]="[25, 75]"
    [minSizes]="[15, 10]"
    layout="horizontal">

    <!-- Left panel -->
    <ng-template #panel>
      <div style="display:flex; flex-direction:column; width:100%; height:100%;">
        <!-- External filter with built-in icon (inside the input) -->
        <div style="margin-bottom:.5rem; padding: 10px 10px 0 10px">
          <p-iconfield iconPosition="left">
            <p-inputicon styleClass="pi pi-search"></p-inputicon>

            <input
              #filterInput
              pInputText
              [(ngModel)]="listFilter"
              (ngModelChange)="applyFilter($event)"
              type="text"
              placeholder="Suchen…"
              class="w-full"
            />
          </p-iconfield>
        </div>

        <!-- Grouped Listbox filling panel height; internal scroll -->
        <p-listbox
          [group]="true"
          [options]="groupedOptions"
          optionGroupLabel="label"
          optionGroupChildren="items"
          [(ngModel)]="selectedItem"
          optionLabel="label"
          optionValue="value"
          [optionDisabled]="isOptionDisabled"
          [style]="{ width:'100%', 'flex-grow':'1', overflow:'auto', border:'none', boxShadow:'none' }"
          [listStyle]="{ overflow:'auto', 'max-height':'100%' }"
          styleClass="left-listbox"
        >
          <!-- GROUP HEADER TEMPLATE (contrast) -->
          <ng-template pTemplate="group" let-group>
            <div
              style="font-weight:700;color:var(--p-primary-color);text-transform:uppercase;letter-spacing:.02em;">
              {{ group.label }}
            </div>
          </ng-template>

          <!-- ITEM TEMPLATE (indent items; show placeholder styling) -->
          <ng-template pTemplate="item" let-item>
            <div
              [style.padding-left]="item.__placeholder ? '.25rem' : '1rem'"
              [style.fontStyle]="item.__placeholder ? 'italic' : null"
              [style.opacity]="item.__placeholder ? 0.75 : 1"
            >
              {{ item.label }}
            </div>
          </ng-template>
        </p-listbox>
      </div>
    </ng-template>

    <!-- Right panel -->
    <ng-template #panel>
      <p-table
        [value]="products"
        size="small"
        dataKey="id"
        [rowTrackBy]="rowTrackBy"
        showGridlines
        [resizableColumns]="true"
        columnResizeMode="expand"
        [paginator]="true"
        paginatorPosition="bottom"
        [rows]="25"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first}–{last} of {totalRecords}"
        [scrollable]="true"
        scrollHeight="flex"
        [style]="{ flex: '1 1 0' }"
        [tableStyle]="{ 'min-width': '50rem', 'width': 'max-content' }"
        sortMode="single">

        <ng-template pTemplate="header">
          <tr>
            <th pResizableColumn pSortableColumn="code" style="width:20%">
              <div style="display:flex;align-items:center;gap:.5rem">
                Code
                <p-sortIcon field="code"></p-sortIcon>
              </div>
            </th>
            <th pResizableColumn pSortableColumn="name" style="width:20%">
              <div style="display:flex;align-items:center;gap:.5rem">
                Name
                <p-sortIcon field="name"></p-sortIcon>
              </div>
            </th>
            <th pResizableColumn pSortableColumn="category" style="width:20%">
              <div style="display:flex;align-items:center;gap:.5rem">
                Category
                <p-sortIcon field="category"></p-sortIcon>
              </div>
            </th>
            <th pResizableColumn pSortableColumn="quantity" style="width:20%; text-align:right">
              <div style="display:flex;align-items:center;gap:.5rem; justify-content:flex-end">
                Quantity
                <p-sortIcon field="quantity"></p-sortIcon>
              </div>
            </th>

            @for (col of dynamicColumns; track col.field) {
              <th pResizableColumn [pSortableColumn]="col.field" style="width:20%">
                <div style="display:flex;align-items:center;gap:.5rem">
                  {{ col.header }}
                  <p-sortIcon [field]="col.field"></p-sortIcon>
                </div>
              </th>
            }
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-product>
          <tr>
            <td>{{ product.code }}</td>
            <td>{{ product.name }}</td>
            <td>{{ product.category }}</td>
            <td style="text-align:right; font-variant-numeric: tabular-nums;">
              {{ product.quantity | number:'1.0-0' }}
            </td>

            @for (col of dynamicColumns; track col.field) {
              <td
                [style.text-align]="isNumber(product[col.field]) ? 'right' : 'left'"
                style="font-variant-numeric: tabular-nums;">
                {{ product[col.field] }}
              </td>
            }
          </tr>
        </ng-template>
      </p-table>
    </ng-template>
  </p-splitter>
</div>
